# Contributor: Jens Pranaitis <jens@jenux.homelinux.org>
# Contributor: Travis Willard <travis@archlinux.org>
# Contributor: amdviaman

pkgname=catalyst
pkgver=8.12
pkgrel=5
pkgdesc="Proprietary AMD/ATI kernel drivers for Radeon brand cards. Stock kernel."
arch=('i686' 'x86_64')
url="http://www.ati.amd.com"
license=('custom') 
depends=("catalyst-utils>=${pkgver}")
makedepends=()
replaces=('ati-fglrx' 'fglrx') # Yay rebranding
install=${pkgname}.install
source=(http://www2.ati.com/drivers/linux/ati-driver-installer-${pkgver/./-}-x86.x86_64.run)
md5sums=('2a62d8c5173f091379e458371782a580')

build() {
    source "${startdir}"/../kernel.env
    cd "${srcdir}"

    [ "$CARCH" = "i686" ] && _arch="x86"
    [ "$CARCH" = "x86_64" ] && _arch="x86_64"

    /bin/sh ./ati-driver-installer-${pkgver/./-}-x86.x86_64.run --extract archive_files
    cd "${srcdir}"/archive_files/common
    cp "${srcdir}"/archive_files/arch/${_arch}/* "${srcdir}"/ -r 
    cp "${srcdir}"/archive_files/common/* "${srcdir}"/ -r 

    if [ "$CARCH" == "x86_64" ]; then
      BUILDARCH=x86_64
      cp "${srcdir}"/archive_files/x710_64a/* "${srcdir}"/ -r
    else
      BUILDARCH=i386
      cp "${srcdir}"/archive_files/x710/* "${srcdir}"/ -r
    fi
    cd "${srcdir}"
    cd "${srcdir}"/lib/modules/fglrx/build_mod/
    echo foo
    #patch -Np1 -i $srcdir/2.6.27.patch ||return 1
    # Build the kernel module
    cp 2.6.x/Makefile .
    make -C $_kerndir SUBDIRS="`pwd`" ARCH=$BUILDARCH modules || return 1

    # Install the kernel module
    install -m 644 -D "${srcdir}"/lib/modules/fglrx/build_mod/fglrx.ko \
        "${pkgdir}"/lib/modules/${_kernver}/video/fglrx.ko

    sed -i -e "s/KERNEL_VERSION=.*/KERNEL_VERSION=${_kernver}/g" $startdir/$install

    # install licenses
    install -m 0644 -D "${srcdir}"/archive_files/ATI_LICENSE.TXT \
                     "${pkgdir}"/usr/share/licenses/${pkgname}/AMD_ATI_LICENSE.TXT

}

