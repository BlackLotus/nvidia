# Contributor: Jens Pranaitis <jens@jenux.homelinux.org>
# Contributor: Dale Blount <dale@archlinux.org>
# Original Contributor: Tom Newsom <Jeepster@gmx.co.uk>
# Portions from AUR john-devel PKGBUILD used with permission from Michal Krenek <mikos@sg1.cz>

pkgname=john
pkgver=1.7.3.1
pkgrel=1
pkgdesc="John the Ripper is a fast password cracker. Additional patches (NTLM, MySQL, Kerberos V5, etc.) included."
arch=(i686 x86_64)
url="http://www.openwall.com/$pkgname/"
depends=('openssl')
license=("GPL")
source=(http://www.openwall.com/$pkgname/g/$pkgname-$pkgver.tar.bz2 \
	ftp://ftp.openwall.com/pub/projects/john/contrib/john-1.7.3.1-all-5.diff.gz
	)
md5sums=('4a8de450ff332bd0c7cbc573eb5032d9'
         '198b96030a679057faadcd318113a787')
build() {
	# jumbo patch
	cd "${srcdir}"/$pkgname-$pkgver
	patch -p1 < "${srcdir}"/$pkgname-1.7.3.1-all-5.diff || return 1
	cd "${srcdir}"/john-$pkgver/src/

	# patch default params
	#patch -p0 < "${srcdir}"/params.h.patch
	if [ "$CARCH" == "x86_64" ]; then
	    sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=x86-64 -DJOHN_SYSTEMWIDE=1|' Makefile
	    sed -i 's|^LDFLAGS =\(.*\)|LDFLAGS =\1 -lm|' Makefile
	    sed -i -e 's|-m486||g' Makefile
	  else sed -i 's|CFLAGS = -c -Wall -O2|CFLAGS = -c -Wall -O2 -march=i686 -DJOHN_SYSTEMWIDE=1|' Makefile
	fi
	#sed -i 's|LIBS = -ldes|LIBS = -ldes -Ldes|' Makefile
	#sed -i 's|#include <des.h>|#include "des/des.h"|' KRB5_fmt.c
	#sed -i 's|#include <des.h>|#include "des/des.h"|' KRB5_std.h

	# build john
	if [ "$CARCH" == "x86_64" ]; then
	    make linux-x86-64 || return 1
	  else make linux-x86-mmx || return 1
	fi

	# config file
	mkdir -p "${pkgdir}"/etc/john
	sed -i 's|$JOHN|/usr/share/john|g' "${srcdir}"/john-$pkgver/run/john.conf
	install -m644 "${srcdir}"/john-$pkgver/run/john.conf "${pkgdir}"/etc/john/john.conf
	
	# docs
	mkdir -p "${pkgdir}"/usr/share/john/doc
	install -m644 "${srcdir}"/john-$pkgver/doc/* "${pkgdir}"/usr/share/john/doc/
	install -m644 "${srcdir}"/john-$pkgver/run/*.chr "${pkgdir}"/usr/share/john/	
	install -m644 "${srcdir}"/john-$pkgver/run/password.lst "${pkgdir}"/usr/share/john/	

	# install binaries
	mkdir -p "${pkgdir}"/usr/bin
	if [ "$CARCH" == "x86_64" ]; then
	    make linux-x86-64 || return 1
	  else 	make linux-x86-mmx || return 1
	fi
	install -m755 "${srcdir}"/john-$pkgver/run/john "${pkgdir}"/usr/bin/john
	install -m755 "${srcdir}"/john-$pkgver/run/mailer "${pkgdir}"/usr/bin/john-mailer
	cd "${pkgdir}"/usr/bin
	ln -s john unafs
	ln -s john unique
	ln -s john unshadow
	ln -s john undrop
}
