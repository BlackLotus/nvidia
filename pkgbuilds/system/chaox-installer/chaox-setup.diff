--- setup	2009-01-17 00:36:06.000000000 +0100
+++ chaox-setup	2009-01-27 21:04:54.104570273 +0100
@@ -1,9 +1,9 @@
 #!/bin/bash
 
 ANSWER="/tmp/.setup"
-TITLE="Arch Linux Installation"
+TITLE="Chaox Installation"
 # use the first VT not dedicated to a running console
-LOG="/dev/tty7"
+LOG="/dev/tty8" # tty7 is dedicated to Xorg
 DESTDIR="/mnt"
 EDITOR=
 
@@ -667,7 +667,8 @@
         # our mirrorlist and pulling the full URL out. Substitute 'core' in
         # for the repository name, and ensure that if it was listed twice we
         # only return one line for the mirror.
-        SYNC_URL=$(egrep -o "${_server}.*" "${MIRRORLIST}" | sed 's/\$repo/core/g' | head -n1)
+        # SYNC_URL=$(egrep -o "${_server}.*" "${MIRRORLIST}" | sed 's/\$repo/core/g' | head -n1)
+        SYNC_URL=$(egrep -o "${_server}.*" "${MIRRORLIST}" | head -n1)
     fi
     echo "Using mirror: $SYNC_URL" >$LOG
 }
@@ -690,6 +691,9 @@
 CacheDir = ${DESTDIR}/var/cache/pacman/pkg
 CacheDir = /src/core/pkg
 
+[livecd]
+Server = http://dev-jenux.homelinux.org/chaox-repo
+
 [core]
 Server = ${serverurl}
 EOF
@@ -703,6 +707,37 @@
     return 0
 }
 
+# do_rsync()
+# does the rsync
+#
+# params: none
+# returns: 1 on error
+do_rsync() {
+    cat > /tmp/rsync-exclude << EOF
+/tmp/*
+/media/*
+/mnt/*
+/arch/
+/dev/*
+/proc/*
+/sys/*
+EOF
+    DIALOG --infobox "Copy in progress. This may take a while - you can watch the output in the progress window." 6 45
+
+    rsync -av / ${DESTDIR} --exclude-from=/tmp/rsync-exclude 2>&1 >$LOG
+
+    mknod -m666 ${DESTDIR}/dev/zero c 1 5
+    mknod -m666 ${DESTDIR}/dev/null c 1 3
+    mknod -m600 ${DESTDIR}/dev/console c 5 1
+    mkdir -m755 ${DESTDIR}/media/{cd,dvd,fl}
+
+    # XXX: Revert mkinitcpio
+    # sed -i 's/^\([A-Z]\+\).*/\1=""/' ${DESTDIR}/etc/mkinitcpio.conf
+    # sed -i 's/^HOOKS=""/HOOKS="base udev autodetect pata scsi sata filesystems"/' ${DESTDIR}/etc/mkinitcpio.conf
+
+    S_SELECT=1
+}
+
 # select_packages()
 # prompts the user to select packages to install
 #
@@ -765,6 +800,90 @@
     S_SELECT=1
 }
 
+# installpkg_chaox()
+# performs package installation to the target system
+# 
+# params: none
+# returns 1 on error
+
+installpkg_chaox() {
+    if [ $S_SELECT -eq 0 ]; then
+        DIALOG --msgbox "You have to copy the distribution first." 0 0
+       return 1
+    fi
+
+    if [ $S_SRC -eq 0 ]; then
+        DIALOG --msgbox "You need do configure your network first". 0 0
+        return 1
+    fi
+
+    DIALOG --msgbox "Package installation will begin now. You can wath the output in the progress window. Please be patient." 0 0
+
+    # must mount chroot so pre/post installs don't fail out
+    chroot_mount
+
+    prepare_pacman
+
+    # execute pacman in a subshell so we can follow its progress
+    # pacman output goes /tmp/pacman.log
+    # /tmp/setup-pacman-running acts as a lockfile
+    ( \
+        echo "Installing Packages..." >/tmp/pacman.log ; \
+        echo >>/tmp/pacman.log ; \
+        touch /tmp/setup-pacman-running ; \
+        $PACMAN -S kernel26-chaox initscripts grub 2>&1 >> /tmp/pacman.log ; \
+        echo $? > /tmp/.pacman-retcode ; \
+        if [ $(cat /tmp/.pacman-retcode) -ne 0 ]; then
+            echo -e "\nPackage Installation FAILED." >>/tmp/pacman.log
+        else
+            echo -e "\nPackage Installation Complete." >>/tmp/pacman.log
+        fi
+        for packet in aufs ndiswrapper sqlzma com-on-air_cs rt2860 rt73-k2wrlz tiacx madwifi-newhal-svn; do
+            $PACMAN -S $packet
+        done
+        rm /tmp/setup-pacman-running
+    ) &
+
+    sleep 2
+    DIALOG --title " Installing... Please Wait " \
+        --no-kill --tailboxbg "/tmp/pacman.log" 18 70 2>$ANSWER
+    while [ -f /tmp/setup-pacman-running ]; do
+        sleep 1
+    done
+
+    kill $(cat $ANSWER)
+
+    # pacman finished, display scrollable output
+    local _result=''
+    if [ $(cat /tmp/.pacman-retcode) -ne 0 ]; then
+        _result="Installation Failed (see errors below)"
+    else
+        _result="Installation Complete"
+    fi
+    rm /tmp/.pacman-retcode
+
+    DIALOG --title "$_result" --exit-label "Continue" \
+        --textbox "/tmp/pacman.log" 18 70 || return 1
+
+    chroot_umount
+
+    sync
+
+    S_INSTALL=1
+
+    # automagic time!
+    # any automatic configuration should go here
+    DIALOG --infobox "Writing base configuration..." 6 40
+    auto_fstab
+
+    # depmod time
+    source ${DESTDIR}/etc/mkinitcpio.d/kernel26-chaox.kver
+    chroot ${DESTDIR} depmod -v ${ALL_kver} 2>&1 >$LOG
+
+    # initscripts backups the following files: etc/inittab etc/rc.conf etc/rc.local etc/rc.local.shutdown
+    mv ${DESTDIR}/etc/rc.conf.pacsave ${DESTDIR}/etc/rc.conf
+    rm ${DESTDIR}/etc/*.pacsave
+}
 
 # installpkg()
 # performs package installation to the target system
@@ -926,9 +1045,9 @@
     DIALOG --yesno "Do you want to use DHCP?" 0 0
     if [ $? -eq 0 ]; then
         DIALOG --infobox "Please wait.  Polling for DHCP server on $INTERFACE..." 10 65
-        dhcpcd $INTERFACE >$LOG 2>&1
+        dhclient $INTERFACE >$LOG 2>&1
         if [ $? -ne 0 ]; then
-            DIALOG --msgbox "Failed to run dhcpcd.  See $LOG for details." 0 0
+            DIALOG --msgbox "Failed to run dhclient.  See $LOG for details." 0 0
             return 1
         fi
         if [ ! $(ifconfig $INTERFACE | grep 'inet addr:') ]; then
@@ -1011,19 +1130,20 @@
             fi
             # remove default entries by truncating file at our little tag (#-*)
             sed -i -e '/#-\*/q' $grubmenu
+	    _cmdline=$(cat /proc/cmdline)
             cat >>$grubmenu <<EOF
 
 # (0) Arch Linux
-title  Arch Linux
+title  Chaox
 root   $grubdev
-kernel $subdir/vmlinuz26 root=${_rootpart} ro
-initrd $subdir/kernel26.img
+kernel $subdir/vmlinuz26 root=${_rootpart} ro $_cmdline
+initrd $subdir/kernel26-chaox.img
 
 # (1) Arch Linux
-title  Arch Linux Fallback
+title  Chaox Fallback
 root   $grubdev
-kernel $subdir/vmlinuz26 root=${_rootpart} ro
-initrd $subdir/kernel26-fallback.img
+kernel $subdir/vmlinuz26 root=${_rootpart} ro $_cmdline
+initrd $subdir/kernel26-chaox-fallback.img
 
 # (2) Windows
 #title Windows
@@ -1103,18 +1223,7 @@
 # returns: nothing
 select_source()
 {
-    DIALOG --menu "Please select an installation source" 10 35 3 \
-    "1" "CD-ROM or OTHER SOURCE" \
-    "2" "FTP/HTTP" 2>$ANSWER
-
-    case $(cat $ANSWER) in
-        "1")
-            MODE="cd"
-            ;;
-        "2")
-            MODE="ftp"
-            ;;
-    esac
+    MODE="ftp"
 
     if [ "$MODE" = "cd" ]; then
         TITLE="Arch Linux CDROM or OTHER SOURCE Installation"
@@ -1125,7 +1234,7 @@
         fi
         echo "Using CDROM for package installation" >$LOG
     else
-        TITLE="Arch Linux FTP/HTTP Installation"
+        TITLE="Chaox Installation"
         DIALOG --msgbox "If you wish to load your ethernet modules manually, please do so now in another terminal." 12 65
          while true; do
             DIALOG --menu "FTP Installation" 10 35 3 \
@@ -1239,7 +1348,7 @@
         touch /tmp/setup-mkinitcpio-running
         echo "mkinitcpio progress ..." > /tmp/mkinitcpio.log; \
         echo >> /tmp/mkinitcpio.log; \
-        chroot "$DESTDIR" /sbin/mkinitcpio -p kernel26 >>/tmp/mkinitcpio.log 2>&1
+        chroot "$DESTDIR" /sbin/mkinitcpio -p kernel26-chaox >>/tmp/mkinitcpio.log 2>&1
         echo $? > /tmp/.mkinitcpio-retcode
         echo >> /tmp/mkinitcpio.log
         rm -f /tmp/setup-mkinitcpio-running
@@ -1358,11 +1467,11 @@
     fi
     DIALOG $DEFAULT --title " MAIN MENU " \
         --menu "Use the UP and DOWN arrows to navigate menus.  Use TAB to switch between buttons and ENTER to select." 16 55 8 \
-        "0" "Select Source" \
+        "0" "Network Configuration" \
         "1" "Set Clock" \
         "2" "Prepare Hard Drive" \
-        "3" "Select Packages" \
-        "4" "Install Packages" \
+        "3" "Copy the Distribution" \
+        "4" "Package Installation" \
         "5" "Configure System" \
         "6" "Install Bootloader" \
         "7" "Exit Install" 2>$ANSWER
@@ -1375,9 +1484,9 @@
         "2")
             prepare_harddrive ;;
         "3")
-            select_packages ;;
+            do_rsync ;;
         "4")
-            installpkg ;;
+            installpkg_chaox ;;
         "5")
             configure_system ;;
         "6")
@@ -1397,12 +1506,13 @@
 #####################
 ## begin execution ##
 
-DIALOG --msgbox "Welcome to the Arch Linux Installation program. The install \
-process is fairly straightforward, and you should run through the options in \
-the order they are presented. If you are unfamiliar with partitioning/making \
-filesystems, you may want to consult some documentation before continuing. \
-You can view all output from commands by viewing your VC7 console (ALT-F7). \
-ALT-F1 will bring you back here." 14 65
+DIALOG --msgbox "Welcome to the Chaox-ng Installation program
+(based on the fabulous Arch Linux Installer)
+
+The install process is fairly straightforward, and you should run through \
+the options in the order they are presented. If you are unfamiliar with \
+non-graphical partition managers, you may want to use gparted instead. \
+You can view all output from commands by viewing your VC8 console (ALT-F8)." 14 65
 
 while true; do
     mainmenu
