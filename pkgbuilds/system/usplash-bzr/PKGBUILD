# Maintainer: Shino <shino@jenux.homelinux.org>
pkgname="usplash-bzr"
pkgver=234
pkgrel=1
pkgdesc="omfg eye candy"
arch=('i686' 'x86_64')
url="https://launchpad.net/usplash"
license=('GPL2')
depends=()
makedepends=('bzr' 'make' 'gcc' 'sed')
provides=("usplash")
conflicts=("usplash")
install="usplash.install"
source=(usplash.initcpio_hook
	usplash.initcpio_install
	usplash.initscript
	usplash.initfunctions
	usplash.diff)

md5sums=('649f3d16e8747a8b61288ee7632b5a79'
	'3d40a44e93a92c1fe603803dafb707d0'
	'22618705fdb34e90ab254c6f6d21d30b'
	'17eba8f0286adb392ceba2f258b0dfc7'
	'a6de5d4ca6e3cfe8ad0a7a1b0acd8f77')

_bzrtrunk="https://code.launchpad.net/~ubuntu-core-dev/usplash/ubuntu"
_bzrmod="usplash"

build() {
	cd "${srcdir}"

	msg "Source checkout..."
	if [ ! -d ./$_bzrmod ]; then
		bzr branch -r $pkgver $_bzrtrunk $_bzrmod
	else
		msg "Build directory already exists"
		return 1
	fi

	_arch=$(uname -m)
	if [ "${_arch}" == "x86_64" ]; then
		_arch="amd64"
	fi

	cd usplash

	sed -i "s|/usr/bin/install|/bin/install|" Makefile
	sed -i "s|\$(shell dpkg-architecture -qDEB_BUILD_ARCH_CPU)|$_arch|" bogl/Makefile
	sed -i "s|/usr/lib/usplash/usplash-artwork.so|/lib/usplash-artwork.so|" usplash.h
	sed -i "s|^CFLAGS=.*|CFLAGS+=-fPIC|" Makefile

	msg "Building..."
	patch -p0 < "${startdir}/usplash.diff" || return 1
	make -j1 BACKEND=svga || return 1

	msg "Installing..."
	make DESTDIR="${pkgdir}" install || return 1

	# Removing unnecessary files
	[ -f "${pkgdir}/usr/sbin/update-usplash-theme" ] && rm "${pkgdir}/usr/sbin/update-usplash-theme"
	[ -f "${pkgdir}/sbin/usplash_down" ] && rm "${pkgdir}/sbin/usplash_down"

	install -D -m644 "${startdir}/usplash.initfunctions" "${pkgdir}/etc/rc.d/functions.d/usplash"
	install -D -m644 "${startdir}/usplash.initcpio_install" "${pkgdir}/lib/initcpio/install/usplash"
	install -D -m644 "${startdir}/usplash.initcpio_hook" "${pkgdir}/lib/initcpio/hooks/usplash"
	install -D -m755 "${startdir}/usplash.initscript" "${pkgdir}/etc/rc.d/usplash"
}
